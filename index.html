<html>

<head>
    <title>YTArchive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tocas-ui/2.3.3/tocas.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocas-ui/2.3.3/tocas.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            setInterval(statuses, 5000);
            setInterval(cookieAvailable, 5000);
            statuses();
            cookieAvailable();
            callbacks();

            document.getElementById("go").addEventListener("click", async e => {
                const url = document.getElementById("videoUrl").value;
                if (!url) return;

                const quality = document.getElementById("quality").value;
                const params = getParams();
                const callback = document.getElementById("callbacks").disabled ? "" : document.getElementById("callbacks").value;

                fetch("/record", {
                    body: JSON.stringify({
                        url,
                        quality,
                        params,
                        callback
                    }),
                    headers: {
                        'content-type': 'application/json'
                    },
                    method: "POST"
                }).then(() => statuses())
            })
        })

        function getParams() {
            let result = {};
            for (const input of document.getElementsByClassName("param")) {
                if (input.dataset.param) {
                    if (input.checked) result[input.dataset.param] = true
                }
                else if (input.dataset.param2) {
                    switch (input.type) {
                        case "text":
                            if (input.value.length) result[input.dataset.param2] = input.value;
                            break;
                        case "number":
                            if (input.value.length && parseInt(input.value) > 0) result[input.dataset.param2] = input.value;
                            break;
                    }
                }
            }
            // Special params
            result[document.getElementById("wait").checked ? "--wait" : "--no-wait"] = true;
            if (document.getElementById("cookie").checked) result["--cookies"] = "./cookie.txt"
            return result;
        }

        async function statuses() {
            const resp = await fetch("/status");
            const data = await resp.json();

            // Remove org data
            const tbody = document.querySelector("tbody");
            tbody.innerHTML = "";

            // Add new data
            const trt = document.getElementById("trTemplate")
            const statust = document.getElementById("statusTemplate")
            const cleart = document.getElementById("clearTemplate")
            for (const [k, v] of Object.entries(data)) {
                const tr = trt.content.querySelector("tr")
                const tds = tr.querySelectorAll("td")
                tds[0].textContent = k;

                let status;
                if (v) {
                    if (v.status === 2) {
                        status = statust.content.querySelector("td.negative")
                    } else if (v.status === 3) {
                        status = statust.content.querySelector("td.info.callback")
                    } else {
                        status = statust.content.querySelector("td.positive")
                    }
                } else {
                    status = statust.content.querySelector("td.info.pending")
                }

                const clone = document.importNode(trt.content, true);
                status = document.importNode(status, true)
                const clear = document.importNode(cleart.content, true)
                clear.querySelector("button").addEventListener("click", () => {
                    fetch(`/status`, {
                        body: JSON.stringify({
                            id: k
                        }),
                        headers: {
                            'content-type': 'application/json'
                        },
                        method: "DELETE"
                    }).then(() => statuses())
                })
                if (!v || v.status === 3) {
                    clear.querySelector("button").disabled = true;
                    clear.querySelector("button").classList.add("disabled")
                }
                status.addEventListener("click", () => {
                    if (v.status === 2) alert(v.output.err)
                    else alert(v.output.out)
                })
                clone.querySelector("tr").appendChild(status)
                clone.querySelector("tr").appendChild(clear)
                tbody.appendChild(clone)
            }
            changeLang(window.lang)
        }
        async function cookieAvailable() {
            const cookie = document.getElementById("cookie")
            const resp = await fetch("/cookie");
            if (resp.status === 404) {
                cookie.checked = false;
                cookie.parentNode.classList.add("disabled");
                cookie.disabled = true;
            } else {
                cookie.parentNode.classList.remove("disabled");
                cookie.disabled = false;
            }
        }
        async function callbacks() {
            const callbacks = document.getElementById("callbacks")
            const resp = await fetch("/callbacks");
            if (resp.status === 404) {
                callbacks.checked = false;
                callbacks.parentNode.classList.add("disabled");
                callbacks.disabled = true;
            } else {
                const data = await resp.json()
                callbacks.parentNode.classList.remove("disabled");
                callbacks.disabled = false;

                for(const title of data){
                    const option = document.createElement("option");
                    option.text = title;
                    callbacks.add(option);
                }
            }
        }
    </script>
    <script>
        const LANGS = {};
        LANGS.zh_TW = {
            addMetadata: "加入中繼資料",
            addThumbnail: "加入 thumbnail",
            waitForLive: "等待直播",
            outputFilename: "輸出檔名",
            retryStream: "串流重試秒數",
            threads: "執行緒數量",
            go: "送出",
            UID: "UID",
            status: "狀態",
            clear: "清除",
            " pending": " 處理中",
            " done": " 已完成",
            " error": " 發生錯誤",
            " caution": " 警告",
            " callback": " 後續處理中",
            "lang": "語言",
            "youtubeVideoURL": "YouTube 影片網址",
            "callback": "Callback"
        }
        LANGS.en_US = {
            addMetadata: "Embed metadata",
            addThumbnail: "Embed thumbnail",
            waitForLive: "Wait for Live",
            outputFilename: "Output Filename",
            retryStream: "Secs for Retrying",
            threads: "Threads",
            go: "SUBMIT",
            UID: "UID",
            status: "Status",
            clear: "Clear",
            " pending": " PENDING",
            " done": " DONE",
            " error": " ERROR",
            " caution": " CAUTION",
            " callback": " CALLBACK",
            "lang": "Language",
            "youtubeVideoURL": "YouTube Video URL",
            "callback": "Callback"
        }

        function changeLang(lang=window.lang){
            for(const elem of document.querySelectorAll("[data-string]")){
                const field = elem.dataset.string;
                if (field.startsWith(" ")) elem.innerHTML = elem.innerHTML.replace(LANGS.zh_TW[field], LANGS[lang][field])
                else if (elem.dataset.placeholder) elem.placeholder = LANGS[lang][field];
                else elem.innerText = LANGS[lang][field];
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            ts('.ts.dropdown:not(.basic)').dropdown();

            window.lang = "zh_TW"
            for(const elem of document.getElementById("langMenu").childNodes){
                elem.addEventListener("click", e => {
                    window.lang = elem.id;
                    changeLang(window.lang)
                })
            }
        })
    </script>
    <style>
        .centerCell {
            text-align: center;
            vertical-align: middle;
        }

        .centerTable {
            margin-left: auto;
            margin-right: auto;
        }

        .hide {
            display: none;
        }

        .ts.checkbox:not(.toggle) {
            margin-top: 3.5px;
        }

        .centerParent {
            display: flex;
            align-items: center;
            justify-content: center;
            align-items: center;
            margin-top: 20%;
        }
    </style>
</head>

<body>
    <div class="ts attached heading slate">
        <div class="ts narrow container">
            <span class="header">YTArchive</span>
            <span class="description"></span>
        </div>
    </div>
    <br><br>
    <div class="ts narrow container">
        <div class="ts floating dropdown labeled icon button">
            <i class="globe icon"></i>
            <span class="text" data-string="lang">語言</span>
            <div class="menu" id="langMenu">
                <div class="item" id="zh_TW">
                    中文(台灣)
                </div>
                <div class="item" id="en_US">
                    English
                </div>
            </div>
        </div>
    </div>
    <br><br>
    <div class="ts narrow container">
        <div class="ts action circular fluid input">
            <input id="videoUrl" type="text" placeholder="Youtube 影片網址" data-string="youtubeVideoURL" data-placeholder="true">
            <select class="ts basic dropdown" id="quality">
                <option>best</option>
                <option>1080p60</option>
                <option>720p60</option>
                <option>720p</option>
                <option>480p</option>
                <option>360p</option>
                <option>240p</option>
                <option>144p</option>
                <option>audio_only</option>
            </select>
        </div>
        <br><br>
        <div class="ts very narrow container">
            <div class="ts stackable grid">
                <div class="three wide column">
                    <div class="ts checkbox">
                        <input type="checkbox" id="addMetadata" data-param="--add-metadata" class="param">
                        <label for="addMetadata" data-string="addMetadata">加入中繼資料</label>
                    </div>
                </div>
                <div class="three wide column">
                    <div class="ts checkbox">
                        <input type="checkbox" id="thumbnail" data-param="--thumbnail" class="param">
                        <label for="thumbnail" data-string="addThumbnail">加入 thumbnail</label>
                    </div>
                </div>
                <div class="three wide column">
                    <div class="ts toggle checkbox">
                        <input type="checkbox" id="wait">
                        <label for="wait" data-string="waitForLive">等待直播</label>
                    </div>
                </div>
                <div class="three wide column">
                    <div class="ts toggle checkbox">
                        <input type="checkbox" id="vp9" data-param="--vp9" class="param">
                        <label for="vp9">VP9</label>
                    </div>
                </div>
                <div class="three wide column">
                    <div class="ts toggle checkbox">
                        <input type="checkbox" id="cookie">
                        <label for="cookie">Cookie</label>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="ts very narrow container">
            <div class="ts small labeled input">
                <div class="ts label" data-string="outputFilename">
                    輸出檔名
                </div>
                <input id="output" data-param2="--output" type="text" class="param" value="%(upload_date)s %(title)s (%(id)s)">
            </div>
            <br><br>
            <div class="ts small labeled input">
                <div class="ts label" data-string="retryStream">
                    串流重試秒數
                </div>
                <input id="retryStream" data-param2="--retry-stream" type="number" class="param">
            </div>
            <br><br>
            <div class="ts small labeled input">
                <div class="ts label" data-string="threads">
                    執行緒數量
                </div>
                <input id="threads" data-param2="--threads" type="number" class="param">
            </div>
            <br><br>
            <div class="ts small labeled input">
                <div class="ts label" data-string="callback">
                    Callback
                </div>
                <select id="callbacks" class="ts basic dropdown">
                    <option></option>
                </select>
            </div>
        </div>
        <br>
        <div class="ts narrow container">
            <center><button class="ts circular positive button" id="go" data-string="go">送出</button></center>
        </div>
        <br>
        <table id="table" class="ts table centerTable">
            <thead>
                <tr class="">
                    <th class="eight wide" data-string="UID">UID</th>
                    <th></th>
                    <th class="three wide" data-string="status">狀態</th>
                    <th class="one wide" data-string="clear">清除</th>
                </tr>
            </thead>
            <tbody></tbody>
            <template id="statusTemplate">
                <td class="info callback" data-string=" callback"><i class="notched circle loading icon"></i> 後續處理中</td>
                <td class="info pending" data-string=" pending"><i class="notched circle loading icon"></i> 處理中</td>
                <td class="positive" data-string=" done"><i class="check icon"></i> 已完成</td>
                <td class="negative" data-string=" error"><i class="remove icon"></i> 發生錯誤</td>
                <td class="warning" data-string=" caution"><i class="caution icon"></i> 警告</td>
            </template>
            <template id="trTemplate">
                <tr>
                    <td name="uid"></td>
                    <td class="centerCell"></td>
                </tr>
            </template>
            <template id="clearTemplate">
                <div class="centerParent">
                    <button class="ts mini compact secondary basic icon button center">
                        <i class="cancel icon"></i>
                    </button>
                </div>
            </template>
        </table>
    </div>
</body>

</html>